<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPS-TOPIK Builder</title>
  <script type="module" src="./eps-topik-builder.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f2f2f2; }
    .soal-card { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input[type="text"] { width: 100%; margin-bottom: 0.5rem; }
    .preview-img { max-width: 100%; margin-top: 0.5rem; border: 1px solid #ccc; }
    .audio-preview { width: 100%; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>📘 EPS-TOPIK Builder</h1><label><b>📛 Nama Set Soal (misal TO1):</b></label> <input type="text" id="setSoal" placeholder="Contoh: TO1" /><br><br>

  <p>📄 Upload gambar soal per nomor:</p>
  <input type="file" id="uploadGambar" multiple accept="image/*" /><br /><br />  <p>🔊 Upload audio gabungan (21-40):</p>
  <input type="file" id="uploadAudioGabungan" accept="audio/*" /><br />
  <label>Dari soal:</label>
  <input type="number" id="audioStart" min="1" style="width:60px;" />
  <label>Sampai:</label>
  <input type="number" id="audioEnd" min="1" style="width:60px;" /><br /><br />  <div id="soalContainer"></div><button id="saveSupabase">💾 Simpan ke Supabase</button> <button id="exportJson">📦 Ekspor JSON</button>

  <script type="module">
    import { uploadAudioGabungan, supabase, simpanSoalToDatabase } from './eps-topik-builder.js';

    const soalList = [];
    const soalContainer = document.getElementById('soalContainer');

    document.getElementById('uploadGambar').addEventListener('change', (e) => {
      const files = Array.from(e.target.files).sort();
      soalList.length = 0;
      soalContainer.innerHTML = '';
      files.forEach((file, i) => {
        const nomor = i + 1;
        const soal = { nomor, gambar: '', pertanyaan: '', opsi: ['', '', '', ''] };
        const reader = new FileReader();
        reader.onload = () => {
          soal.gambar = reader.result;
          renderSoalCard(soal);
        };
        reader.readAsDataURL(file);
        soalList.push(soal);
      });
    });

    document.getElementById('uploadAudioGabungan').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      const start = parseInt(document.getElementById('audioStart').value);
      const end = parseInt(document.getElementById('audioEnd').value);
      if (!file || isNaN(start) || isNaN(end)) return alert('Lengkapi data rentang soal.');
      const url = await uploadAudioGabungan(file);
      for (let i = start; i <= end; i++) {
        const soal = soalList.find(s => s.nomor === i);
        if (soal) soal.audio_gabungan = url;
      }
      alert('✅ Audio gabungan ditautkan ke soal!');
    });

    function renderSoalCard(soal) {
      const card = document.createElement('div');
      card.className = 'soal-card';
      card.innerHTML = `<h3>Soal ${soal.nomor}</h3>
        <img src="${soal.gambar}" class="preview-img" alt="soal-${soal.nomor}" />
        <input type="text" placeholder="Opsi 1" value="${soal.opsi[0]}"><br>
        <input type="text" placeholder="Opsi 2" value="${soal.opsi[1]}"><br>
        <input type="text" placeholder="Opsi 3" value="${soal.opsi[2]}"><br>
        <input type="text" placeholder="Opsi 4" value="${soal.opsi[3]}"><br>`;
      const inputs = card.querySelectorAll('input');
      inputs.forEach((inp, idx) => {
        inp.oninput = () => soal.opsi[idx] = inp.value;
      });
      soalContainer.appendChild(card);
    }

    document.getElementById('saveSupabase').onclick = () => {
      const setId = document.getElementById('setSoal').value.trim();
      if (!setId) return alert('⚠️ Masukkan nama set soal terlebih dahulu');
      simpanSoalToDatabase(soalList, setId);
    };

    document.getElementById('exportJson').onclick = () => {
      const hasil = soalList.map(s => ({
        nomor: s.nomor,
        pertanyaan: s.pertanyaan,
        opsi: s.opsi,
        gambar: s.gambar,
        audio_gabungan: s.audio_gabungan || null
      }));
      const blob = new Blob([JSON.stringify(hasil, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'soal.json';
      a.click();
    };
  </script></body>
</html>
